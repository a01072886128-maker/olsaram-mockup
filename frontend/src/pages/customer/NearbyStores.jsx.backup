import { useState, useEffect } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import {
  MapPin,
  Star,
  Clock,
  Users,
  Navigation,
  Filter,
  X,
  Phone,
  Calendar,
  MessageSquare,
  ChevronRight,
  LogOut,
  Loader2,
} from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '../../components/ui/card';
import { Button } from '../../components/ui/button';
import { Badge } from '../../components/ui/badge';
import { Dialog } from '../../components/ui/dialog';
import { Input } from '../../components/ui/input';
import { Select } from '../../components/ui/select';
import { Textarea } from '../../components/ui/textarea';
import { Alert, AlertDescription } from '../../components/ui/alert';
import { useAuth } from '../../contexts/AuthContext';
import { storeAPI } from '../../services/store';

const DEFAULT_LOCATION = {
  lat: 35.1495,
  lng: 126.9173,
  name: 'ê´‘ì£¼ ê¸ˆë‚¨ë¡œ',
};

function NearbyStores() {
  const navigate = useNavigate();
  const { user, logout } = useAuth();

  // ìƒíƒœ ê´€ë¦¬
  const [location, setLocation] = useState(null);
  const [stores, setStores] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [sortBy, setSortBy] = useState('distance'); // 'distance' | 'rating'
  const [selectedStore, setSelectedStore] = useState(null);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [showReservationModal, setShowReservationModal] = useState(false);

  // ì˜ˆì•½ í¼ ìƒíƒœ
  const [reservationForm, setReservationForm] = useState({
    date: '',
    time: '',
    partySize: 2,
    menuItems: [],
    requests: '',
  });

  // ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­
  const requestLocation = () => {
    console.log('ğŸ” ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ ì‹œì‘');
    setIsLoading(true);
    setError(null);

    if (!navigator.geolocation) {
      console.error('âŒ Geolocation API ë¯¸ì§€ì›');
      setError('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ê´‘ì£¼ ê¸ˆë‚¨ë¡œ)ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.');
      setLocation(DEFAULT_LOCATION);
      fetchNearbyStores(DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lng);
      return;
    }

    console.log('ğŸ“ Geolocation API í˜¸ì¶œ ì¤‘...');
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        console.log('âœ… ìœ„ì¹˜ íšë“ ì„±ê³µ:', latitude, longitude);
        setLocation({ lat: latitude, lng: longitude, name: 'í˜„ì¬ ìœ„ì¹˜' });
        fetchNearbyStores(latitude, longitude);
      },
      (error) => {
        console.error('âŒ ìœ„ì¹˜ ê¶Œí•œ ì˜¤ë¥˜:', error);
        setError('ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ê´‘ì£¼ ê¸ˆë‚¨ë¡œ)ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.');
        setLocation(DEFAULT_LOCATION);
        fetchNearbyStores(DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lng);
      },
      {
        enableHighAccuracy: false,
        timeout: 10000,
        maximumAge: 0
      }
    );
  };

  // ë‚´ ì£¼ë³€ ë§›ì§‘ ê²€ìƒ‰
  const fetchNearbyStores = async (lat, lng) => {
    try {
      setIsLoading(true);
      const data = await storeAPI.getNearbyStores(lat, lng, 5000);
      setStores(data.stores || data || []);
    } catch (err) {
      console.error('ë§›ì§‘ ê²€ìƒ‰ ì˜¤ë¥˜:', err);
      setError(err.message || 'ë§›ì§‘ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      setStores([]);
    } finally {
      setIsLoading(false);
    }
  };

  // ì •ë ¬ëœ ë§›ì§‘ ëª©ë¡
  const sortedStores = [...stores].sort((a, b) => {
    if (sortBy === 'distance') {
      return (a.distance || 0) - (b.distance || 0);
    }
    return (b.rating || 0) - (a.rating || 0);
  });

  // ë§›ì§‘ ì¹´ë“œ í´ë¦­
  const handleStoreClick = async (store) => {
    setSelectedStore(store);
    setShowDetailModal(true);
  };

  // ì˜ˆì•½í•˜ê¸° ë²„íŠ¼
  const handleReservationClick = () => {
    setShowDetailModal(false);
    setShowReservationModal(true);
  };

  // ì˜ˆì•½ ì œì¶œ
  const handleReservationSubmit = async () => {
    try {
      const reservationData = {
        storeId: selectedStore.id,
        customerId: user?.customerId,
        date: reservationForm.date,
        time: reservationForm.time,
        partySize: reservationForm.partySize,
        menuItems: reservationForm.menuItems,
        requests: reservationForm.requests,
      };

      await storeAPI.createReservation(reservationData);
      alert('ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      setShowReservationModal(false);
      setReservationForm({
        date: '',
        time: '',
        partySize: 2,
        menuItems: [],
        requests: '',
      });
    } catch (err) {
      alert(err.message || 'ì˜ˆì•½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  };

  const handleLogout = () => {
    logout();
    navigate('/', { replace: true });
  };

  return (
    <div className="min-h-screen bg-slate-50">
      {/* Header */}
      <header className="sticky top-0 z-50 border-b bg-white">
        <div className="container mx-auto px-8 h-20 flex items-center justify-between">
          <div className="flex items-center gap-12">
            <Link
              to="/"
              className="text-2xl font-bold text-slate-900 hover:text-blue-600 transition-colors"
            >
              ì˜¬ì‚¬ëŒ
            </Link>
            <nav className="hidden md:flex gap-10">
              <Link
                to="/customer/search"
                className="text-base text-slate-600 hover:text-slate-900 transition-colors"
              >
                ê°€ê²Œ ê²€ìƒ‰
              </Link>
              <Link
                to="/customer/nearby"
                className="text-base text-slate-900 font-semibold border-b-2 border-blue-600 pb-[26px]"
              >
                ë‚´ ì£¼ë³€ ë§›ì§‘
              </Link>
              <Link
                to="/customer/mypage"
                className="text-base text-slate-600 hover:text-slate-900 transition-colors"
              >
                ë§ˆì´í˜ì´ì§€
              </Link>
            </nav>
          </div>
          <div className="flex items-center gap-4">
            <span className="text-sm text-slate-600">
              {user?.name || 'ê³ ê°'}ë‹˜
            </span>
            <Button variant="outline" onClick={handleLogout}>
              <LogOut className="w-4 h-4 mr-2" />
              ë¡œê·¸ì•„ì›ƒ
            </Button>
          </div>
        </div>
      </header>

      <main className="container mx-auto px-6 py-8">
        {/* íƒ€ì´í‹€ & ìœ„ì¹˜ ìš”ì²­ */}
        <div className="mb-8">
          <h2 className="mb-4 text-2xl font-bold text-slate-900">
            ë‚´ ì£¼ë³€ ë§›ì§‘ ì°¾ê¸°
          </h2>
          {!location ? (
            <Card className="border-blue-200 bg-blue-50">
              <CardContent className="pt-6">
                <div className="flex flex-col items-center gap-4">
                  {isLoading ? (
                    <>
                      <Loader2 className="w-12 h-12 text-blue-600 animate-spin" />
                      <p className="text-center text-slate-700 font-medium">
                        ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                      </p>
                      <p className="text-center text-sm text-slate-500">
                        ë¸Œë¼ìš°ì € ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”
                      </p>
                    </>
                  ) : (
                    <>
                      <Navigation className="w-12 h-12 text-blue-600" />
                      <p className="text-center text-slate-700">
                        ë‚´ ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì£¼ë³€ ë§›ì§‘ì„ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤
                      </p>
                      <Button
                        onClick={requestLocation}
                        className="bg-blue-600 hover:bg-blue-700"
                      >
                        <MapPin className="w-4 h-4 mr-2" />
                        ë‚´ ì£¼ë³€ ë§›ì§‘ ì°¾ê¸°
                      </Button>
                      <p className="text-xs text-slate-500">
                        ê¶Œí•œ ê±°ë¶€ ì‹œ ê´‘ì£¼ ê¸ˆë‚¨ë¡œ ê¸°ì¤€ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤
                      </p>
                    </>
                  )}
                </div>
              </CardContent>
            </Card>
          ) : (
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2 text-slate-600">
                <MapPin className="w-5 h-5 text-blue-600" />
                <span>{location.name}</span>
                <Badge variant="outline">{stores.length}ê°œ ë°œê²¬</Badge>
              </div>
              <div className="flex items-center gap-2">
                <Filter className="w-4 h-4 text-slate-400" />
                <select
                  value={sortBy}
                  onChange={(e) => setSortBy(e.target.value)}
                  className="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="distance">ê±°ë¦¬ìˆœ</option>
                  <option value="rating">í‰ì ìˆœ</option>
                </select>
              </div>
            </div>
          )}
        </div>

        {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
        {error && (
          <Alert className="mb-6 border-orange-200 bg-orange-50">
            <AlertDescription className="text-orange-900">
              {error}
            </AlertDescription>
          </Alert>
        )}

        {/* ë§›ì§‘ ì¹´ë“œ ê·¸ë¦¬ë“œ */}
        {isLoading && location ? (
          <div className="text-center py-12 text-slate-600">
            ë§›ì§‘ì„ ê²€ìƒ‰í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...
          </div>
        ) : stores.length === 0 && location ? (
          <div className="text-center py-12 text-slate-600">
            ì£¼ë³€ì— ë“±ë¡ëœ ë§›ì§‘ì´ ì—†ìŠµë‹ˆë‹¤
          </div>
        ) : (
          <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {sortedStores.map((store, index) => (
              <motion.div
                key={store.id}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: index * 0.1 }}
              >
                <Card
                  className="cursor-pointer hover:shadow-lg transition-shadow"
                  onClick={() => handleStoreClick(store)}
                >
                  {store.imageUrl && (
                    <div className="h-48 bg-slate-200 rounded-t-lg overflow-hidden">
                      <img
                        src={store.imageUrl}
                        alt={store.name}
                        className="w-full h-full object-cover"
                      />
                    </div>
                  )}
                  <CardHeader>
                    <div className="flex items-start justify-between">
                      <CardTitle className="text-lg">{store.name}</CardTitle>
                      <Badge className="bg-blue-600">{store.category || 'í•œì‹'}</Badge>
                    </div>
                    <div className="flex items-center gap-4 text-sm text-slate-600 mt-2">
                      <div className="flex items-center gap-1">
                        <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                        <span>{store.rating?.toFixed(1) || '0.0'}</span>
                      </div>
                      <div className="flex items-center gap-1">
                        <MapPin className="w-4 h-4" />
                        <span>{store.distance?.toFixed(1) || '0.0'}km</span>
                      </div>
                    </div>
                  </CardHeader>
                  <CardContent>
                    <p className="text-sm text-slate-600 mb-3 line-clamp-2">
                      {store.address}
                    </p>
                    {store.representativeMenus && store.representativeMenus.length > 0 && (
                      <div className="flex gap-2">
                        {store.representativeMenus.slice(0, 2).map((menu, idx) => (
                          <Badge key={idx} variant="outline">
                            {menu}
                          </Badge>
                        ))}
                      </div>
                    )}
                    {store.businessHours && (
                      <div className="flex items-center gap-1 mt-3 text-xs text-slate-500">
                        <Clock className="w-3 h-3" />
                        <span>{store.businessHours}</span>
                      </div>
                    )}
                  </CardContent>
                </Card>
              </motion.div>
            ))}
          </div>
        )}
      </main>

      {/* ìƒì„¸ ëª¨ë‹¬ */}
      {showDetailModal && selectedStore && (
        <Dialog open={showDetailModal} onOpenChange={setShowDetailModal}>
          <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
                <h3 className="text-xl font-bold">{selectedStore.name}</h3>
                <button
                  onClick={() => setShowDetailModal(false)}
                  className="text-slate-400 hover:text-slate-600"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>

              <div className="p-6 space-y-6">
                {selectedStore.imageUrl && (
                  <img
                    src={selectedStore.imageUrl}
                    alt={selectedStore.name}
                    className="w-full h-64 object-cover rounded-lg"
                  />
                )}

                <div className="space-y-4">
                  <div className="flex items-center gap-4">
                    <div className="flex items-center gap-1">
                      <Star className="w-5 h-5 fill-yellow-400 text-yellow-400" />
                      <span className="font-semibold">{selectedStore.rating?.toFixed(1)}</span>
                    </div>
                    <div className="flex items-center gap-1 text-slate-600">
                      <MapPin className="w-4 h-4" />
                      <span>{selectedStore.distance?.toFixed(1)}km</span>
                    </div>
                  </div>

                  <div className="space-y-2">
                    <p className="text-slate-600">{selectedStore.address}</p>
                    {selectedStore.phone && (
                      <div className="flex items-center gap-2 text-slate-600">
                        <Phone className="w-4 h-4" />
                        <span>{selectedStore.phone}</span>
                      </div>
                    )}
                    {selectedStore.businessHours && (
                      <div className="flex items-center gap-2 text-slate-600">
                        <Clock className="w-4 h-4" />
                        <span>{selectedStore.businessHours}</span>
                      </div>
                    )}
                  </div>

                  {selectedStore.description && (
                    <div>
                      <h4 className="font-semibold mb-2">ì†Œê°œ</h4>
                      <p className="text-slate-600">{selectedStore.description}</p>
                    </div>
                  )}

                  {selectedStore.menus && selectedStore.menus.length > 0 && (
                    <div>
                      <h4 className="font-semibold mb-3">ë©”ë‰´</h4>
                      <div className="space-y-2">
                        {selectedStore.menus.map((menu, idx) => (
                          <div
                            key={idx}
                            className="flex items-center justify-between p-3 bg-slate-50 rounded-lg"
                          >
                            <span>{menu.name}</span>
                            <span className="font-semibold text-blue-600">
                              {menu.price?.toLocaleString()}ì›
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                <Button
                  onClick={handleReservationClick}
                  className="w-full bg-blue-600 hover:bg-blue-700"
                >
                  <Calendar className="w-4 h-4 mr-2" />
                  ì˜ˆì•½í•˜ê¸°
                </Button>
              </div>
            </div>
          </div>
        </Dialog>
      )}

      {/* ì˜ˆì•½ ëª¨ë‹¬ */}
      {showReservationModal && selectedStore && (
        <Dialog open={showReservationModal} onOpenChange={setShowReservationModal}>
          <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg max-w-md w-full">
              <div className="border-b px-6 py-4 flex items-center justify-between">
                <h3 className="text-xl font-bold">ì˜ˆì•½í•˜ê¸°</h3>
                <button
                  onClick={() => setShowReservationModal(false)}
                  className="text-slate-400 hover:text-slate-600"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>

              <div className="p-6 space-y-4">
                <div>
                  <p className="font-semibold mb-1">{selectedStore.name}</p>
                  <p className="text-sm text-slate-600">{selectedStore.address}</p>
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">ë‚ ì§œ</label>
                  <Input
                    type="date"
                    value={reservationForm.date}
                    onChange={(e) =>
                      setReservationForm({ ...reservationForm, date: e.target.value })
                    }
                    min={new Date().toISOString().split('T')[0]}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">ì‹œê°„</label>
                  <select
                    value={reservationForm.time}
                    onChange={(e) =>
                      setReservationForm({ ...reservationForm, time: e.target.value })
                    }
                    className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">ì‹œê°„ ì„ íƒ</option>
                    {Array.from({ length: 13 }, (_, i) => i + 11).map((hour) => (
                      <option key={hour} value={`${hour}:00`}>
                        {hour}:00
                      </option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">ì¸ì›</label>
                  <div className="flex items-center gap-2">
                    <Users className="w-4 h-4 text-slate-400" />
                    <select
                      value={reservationForm.partySize}
                      onChange={(e) =>
                        setReservationForm({
                          ...reservationForm,
                          partySize: parseInt(e.target.value),
                        })
                      }
                      className="flex-1 px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      {Array.from({ length: 10 }, (_, i) => i + 1).map((num) => (
                        <option key={num} value={num}>
                          {num}ëª…
                        </option>
                      ))}
                    </select>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">ìš”ì²­ì‚¬í•­ (ì„ íƒ)</label>
                  <Textarea
                    placeholder="íŠ¹ë³„í•œ ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì…ë ¥í•´ì£¼ì„¸ìš”"
                    value={reservationForm.requests}
                    onChange={(e) =>
                      setReservationForm({ ...reservationForm, requests: e.target.value })
                    }
                    rows={3}
                  />
                </div>

                <Button
                  onClick={handleReservationSubmit}
                  className="w-full bg-blue-600 hover:bg-blue-700"
                  disabled={!reservationForm.date || !reservationForm.time}
                >
                  ì˜ˆì•½ ì™„ë£Œ
                </Button>
              </div>
            </div>
          </div>
        </Dialog>
      )}
    </div>
  );
}

export default NearbyStores;
